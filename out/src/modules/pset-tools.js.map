{"version":3,"file":"pset-tools.js","sourceRoot":"./src/","sources":["src/modules/pset-tools.ts"],"names":[],"mappings":"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","sourcesContent":["import { GuildMember } from \"discord.js\";\nimport { inspect } from \"util\";\nimport { CommandError } from \"../commands/errors\";\nimport { PermSetLoader } from \"../commands/guards\";\nimport { PermissionSetEntity } from \"../commands/permissions/types\";\nimport { Command, Commands } from \"../commands/util\";\n\n/**\n * Command builder for a membership target modifier\n * @param target role or member\n * @param state add or remove\n */\nconst TargetModifier: (target: \"role\" | \"member\", state: \"add\" | \"del\") => Command = (target, state) => ({\n    opts: {\n        name: `${state}-${target}-pset`,\n        node: \"perm.manage-members\",\n        usage: {\n            // ternary stuff in interpolation is for grammar\n            description: `${state === \"add\" ? \"Add\" : \"Remove\"} ${target}s ${state === \"add\" ? \"to\" : \"from\"} a permission set`,\n            args: [\n                {\n                    type: \"string\",\n                    name: \"pset-name\",\n                    description: \"The set to look up\",\n                    required: true\n                },\n                {\n                    type: target === \"member\" ? \"member\" : \"string\",\n                    name: `${target}-ids`,\n                    description: \"The targets to add/remove\",\n                    required: true,\n                    unlimited: true\n                }\n            ]\n        },\n        guards: [\n            PermSetLoader\n        ]\n    },\n    handler: async (message, next) => {\n        const [, ...ids] = message.args;\n\n        const permSet: PermissionSetEntity = message.data.permSet;\n\n        // addTarget() or delTarget()\n        permSet[state + \"Target\"](target, ...(typeof ids[0] === \"string\" ? ids : (ids as GuildMember[]).map(member => member.id)));\n\n        await permSet.save();\n        await message.success();\n        next();\n    }\n});\n\n/**\n * Command builder for a permission state modifier\n * @param action the permission action\n */\nconst PermissionStateModifier: (action: \"grant\" | \"negate\" | \"reset\") => Command = action => ({\n    opts: {\n        name: `${action}-perm`,\n        node: \"perm.manage-perm\",\n        usage: {\n            // ternary stuff in interpolation is for grammar\n            description: `${action.capitalize()} a permission ${action === \"negate\" ? \"from\" : \"in\"} a permission set`,\n            args: [\n                {\n                    type: \"string\",\n                    name: \"name\",\n                    description: \"The set to modify\",\n                    required: true\n                },\n                {\n                    type: \"string\",\n                    name: \"permissions\",\n                    description: \"The permissions to set\",\n                    required: true,\n                    unlimited: true\n                }\n            ]\n        },\n        guards: [\n            PermSetLoader\n        ]\n    },\n    handler: async (message, next) => {\n        const [, ...permissions] = message.args.map(p => p.toString());\n\n        const permSet: PermissionSetEntity = message.data.permSet;\n\n        // calls permSet.grant(), permSet.negate(), permSet.reset() depending on action variable\n        permissions.forEach(permission => permSet[action](permission));\n\n        await permSet.save();\n        await message.success();\n    }\n})\n\nexport const PsetTools: Commands = {\n    opts: {\n        environments: ['text'],\n        category: \"Permissions\"\n    },\n    commands: [\n        {\n            opts: {\n                name: \"create-pset\",\n                node: \"perm.create-pset\",\n                usage: {\n                    description: \"Create a permission set\",\n                    args: [\n                        {\n                            type: \"string\",\n                            name: \"name\",\n                            description: \"The name of the set being created\",\n                            required: true\n                        }\n                    ]\n                }\n            },\n            /**\n             * Creates a bare permission set\n             */\n            handler: async (message, next) => {\n                const [ name ] = message.args as string[];\n                const guild = message.guild.id;\n                const entity = await message.client.botkit.options.permissionsEntity!.findOne({name, guild});\n\n                if (entity) {\n                    return next(new CommandError({\n                        title: \"Name Unavailable\",\n                        message: `The name \\`${name}\\` is already taken. Please choose another name.`\n                    }));\n                }\n\n                const permSet = await message.client.botkit.options.permissionsEntity!.create({\n                    guild,\n                    name: name.toString(),\n                    roles: [],\n                    members: [],\n                    grantedPermissions: [],\n                    negatedPermissions: []\n                });\n\n                const id = await permSet.save().then(set => set.id);\n\n                await message.reply(`Permission set created. Name: \\`${name}\\``);\n                next();\n            }\n        },\n        {\n            opts: {\n                name: \"get-pset\",\n                node: \"perm.get-pset\",\n                usage: {\n                    description: \"Get a permission set\",\n                    args: [\n                        {\n                            type: \"string\",\n                            name: \"name\",\n                            description: \"The set to look up\",\n                            required: true\n                        }\n                    ]\n                },\n                guards: [\n                    PermSetLoader\n                ]\n            },\n            /**\n             * Returns a raw util.inspect() of the permission set\n             */\n            handler: async (message, next) => {\n                const permSet: PermissionSetEntity = message.data.permSet;\n\n                const description = inspect(permSet.json, false, 1);\n\n                await message.reply(`\\`\\`\\`js\\n${description}\\n\\`\\`\\``);\n\n                next();\n            }\n        },\n        TargetModifier(\"role\", \"add\"),\n        TargetModifier(\"role\", \"del\"),\n        TargetModifier(\"member\", \"add\"),\n        TargetModifier(\"member\", \"del\"),\n        PermissionStateModifier(\"grant\"),\n        PermissionStateModifier(\"negate\"),\n        PermissionStateModifier(\"reset\")\n    ]\n}"]}